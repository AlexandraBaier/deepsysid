# deepsysid

A system identification toolkit for multistep prediction using deep learning and hybrid methods.

## How to use?

Install via pip:
```
pip install git+https://github.com/AlexandraBaier/deepsysid.git
```

### Environment Variables

Set the following environment variables:
```
DATASET_DIRECTORY=<root directory of dataset with at least child directory processed>
RESULT_DIRECTORY=<directory for validation/test results>
CONFIGURATION=<JSON configuration file>
```

### Directories

### Configuration

The JSON configuration file is used to set hyperparameters for any model in the `deepsysid` package.
The JSON file has the following format:
```json
{
  "train_fraction": "float < 1.0",
  "validation_fraction": "float < 1.0",
  "time_delta": "float, sampling rate of dataset in seconds",
  "window": "int, size of window of initial state and control inputs during evaluation",
  "horizon": "int, prediction horizon used during evaluation",
  "control_names": "list of strings, names of control/external inputs as defined in the dataset CSV",
  "state_names": "list of strings, names of measured (and also predicted) system states as defined in the dataset CSV",
  "thresholds": "list of floats, threshold values for which the hybrid models should be evaluated",
  "models": {
    "str, unique name of model": {
      "model_class": "str, full Python class name of model including full package, for example, deepsysid.models.linear.LinearModel",
      "location": "str, directory where model files should be saved such as weights and normalization parameters",
      "parameters": {
        "hyperparameter_name": "hyperparameter_value, an example follows",
        "dropout": 0.25
      }
    }
  }
}
```

Alternatively, a gridsearch template JSON format can be used to generate the above configuration file
using the script `scripts/build_gridsearch_configuration.py`.
It allows the generation of models with a large number of hyperparameter combinations. 
The gridsearch template has the following format:
```json
{
  "base_path": "str, directory where all trained models should be saved to, subdirectories will be created for each separate model",
  "settings": {
    "train_fraction": "float < 1.0",
    "validation_fraction": "float < 1.0",
    "time_delta": "float",
    "window": "int",
    "horizon": "int",
    "control_names": "list of strings",
    "state_names": "list of strings",
    "thresholds": "list of floats",
    "models": [
      {
        "model_base_name": "str, base name of model will be extended by combination of hyperparameter",
        "model_class": "str",
        "static_parameters": {
          "hyperparameter name": "hyperparameter value, static parameters remain the same for all models of this base_name, no grid search will be performed over these parameters"
        },
        "flexible_parameters": {
          "hyperparameter name": "list of hyperparameter values, gridsearch is performed over flexible parameters, the cartesian product over all possible flexible parameter combinations is generated as distinct models"
        }
      }
    ]
  }
}
```
If you use the template format, the environment variable should still point to the JSON configuration file, that is generated by the script.
An example template can be found under `examples/patrol_ship.template.json`.

### Training

`scripts/train_model.py [--enable-cuda] [--device-idx={n}] [--disable-stdout] model`

Arguments:
- model: name of model as defined in configuration
- `--enable-cuda`: Optional flag. Script will pass device-name `cuda` to model. Models that support GPU usage will run accordingly.
- `--device-idx={n}`: Optional (only in combination with `--enable-cuda`). Script will pass device name `cuda:n` to model, where `n` is an integer greater or equal to 0.
- `--disable-stdout`: Optional flag. Script will not print logging to stdout, however will still log to .txt file in model directory.

### Testing

`scripts/train_model.py [--enable-cuda] [--device-idx={n}] --mode={train|validation|test} model`

Arguments:
- model: name of model as defined in configuration
- `--enable-cuda`: Optional flag. Script will pass device-name `cuda` to model. Models that support GPU usage will run accordingly.
- `--device-idx={n}`: Optional (only in combination with `--enable-cuda`). Script will pass device name `cuda:n` to model, where `n` is an integer greater or equal to 0.
- `--disable-stdout`: Required. Choose either `train`, `validation` or `test` to select what dataset to run the evaluation on. 


## References

[Baier, A., Boukhers, Z., & Staab, S. (2021). Hybrid Physics and Deep Learning Model for Interpretable Vehicle State Prediction. ArXiv, abs/2103.06727.](https://arxiv.org/abs/2103.06727)